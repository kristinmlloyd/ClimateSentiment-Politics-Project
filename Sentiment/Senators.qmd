---
title: "Untitled"
format: html
---

```{python}

import pandas as pd
from transformers import AutoModelForSequenceClassification, AutoTokenizer, pipeline
import torch
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.decomposition import LatentDirichletAllocation

```

```{python}

df = pd.read_csv("../Data/raw-data/Senators.csv")

device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
model_name = "climatebert/distilroberta-base-climate-sentiment"
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForSequenceClassification.from_pretrained(model_name)
model.to(device)

sentiment_pipeline = pipeline(
    "sentiment-analysis",
    model=model,
    tokenizer=tokenizer,
    device=0 if torch.cuda.is_available() else -1
)

def get_sentiment(text):
    if pd.isna(text) or text.strip() == "":
        return "neutral", 0.0  
    result = sentiment_pipeline(text)
    return result[0]['label'], result[0]['score']

df[['model_label', 'Score']] = df['content'].apply(lambda x: pd.Series(get_sentiment(str(x))))

def check_label_match(row):
    return 1 if row['model_label'] == row['independent_label'] else 0

df['labels_match'] = df.apply(check_label_match, axis=1)

output_file = '../Data/processed-data/Senators_sentiment_results.csv'
df.to_csv(output_file, index=False)

```

```{python}

counts = df['labels_match'].value_counts()

print(f"Number of 0's: {counts.get(0, 0)}")
print(f"Number of 1's: {counts.get(1, 0)}")

```

```{python}

df = pd.read_csv("../Data/processed-data/Senators_sentiment_results.csv")

```

```{python}

model_name = "SamLowe/roberta-base-go_emotions"
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForSequenceClassification.from_pretrained(model_name)

emotion_pipeline = pipeline(
    "text-classification",
    model=model,
    tokenizer=tokenizer,
    padding=True,          
    truncation=True,       
    max_length=512         
)

def detect_emotion(text):
    if isinstance(text, str) and len(text.strip()) > 0:
        try:
            result = emotion_pipeline(text)
            return result[0]['label'], result[0]['score']
        except IndexError:
            return None, None
    return None, None

df[['emotion', 'confidence']] = df['content'].apply(
    lambda x: pd.Series(detect_emotion(x))
)

output_file = "../Data/processed-data/Senators_sentiment_results.csv"
df.to_csv(output_file, index=False)

```

```{python}

text_data = df['content'].dropna().astype(str)

vectorizer = CountVectorizer(
    max_df=0.95,  
    min_df=2,    
    stop_words='english'  
)
text_vectors = vectorizer.fit_transform(text_data)

num_topics = 5 
lda = LatentDirichletAllocation(n_components=num_topics, random_state=42)
lda.fit(text_vectors)

def get_top_words(model, feature_names, n_top_words):
    topics = {}
    for topic_idx, topic in enumerate(model.components_):
        top_words = [feature_names[i] for i in topic.argsort()[:-n_top_words - 1:-1]]
        topics[topic_idx] = ', '.join(top_words)  
    return topics

n_top_words = 10
feature_names = vectorizer.get_feature_names_out()
topics = get_top_words(lda, feature_names, n_top_words)

print("Discovered Topics:")
for topic_idx, words in topics.items():
    print(f"Topic {topic_idx}: {words}")

topic_probabilities = lda.transform(text_vectors)  
topic_assignments = topic_probabilities.argmax(axis=1) 

topic_labels = [topics[topic_idx] for topic_idx in topic_assignments]

filtered_df = df.loc[df['content'].notna()].copy()
filtered_df['dominant_topic'] = topic_labels  
filtered_df['topic_probability'] = topic_probabilities.max(axis=1)

df = pd.concat([df, filtered_df[['dominant_topic', 'topic_probability']]], axis=1)

output_file = "../Data/processed-data/Senators_sentiment_results.csv"
df.to_csv(output_file, index=False)

```

```{python}

df = pd.read_csv("../Data/processed-data/Senators_sentiment_results.csv")

```

```{python}

df['independent_label'] = df['independent_label'].replace('neural', 'neutral')
df['model_label'] = df['model_label'].replace('neural', 'neutral')

df.to_csv("../Data/processed-data/Senators_sentiment_results.csv", index=False)

```

